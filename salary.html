<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary/Payroll - Indian Payroll System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Indian Payroll System</div>
        <ul class="nav-menu">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="employees.html">Employees</a></li>
            <li><a href="attendance.html">Attendance</a></li>
            <li><a href="salary.html" class="active">Salary/Payroll</a></li>
            <li><a href="leaves.html">Leave Management</a></li>
            <li><a href="loans.html">Loans & Advances</a></li>
            <li><a href="reimbursements.html">Reimbursements</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
        <div class="user-info">
            <span id="userDisplay"></span>
        </div>
    </nav>

    <div class="container">
        <h1>Salary & Payroll Management</h1>
        
        <div class="action-bar">
            <select id="salaryMonth">
                <option value="2024-01">January 2024</option>
                <option value="2024-02">February 2024</option>
                <option value="2024-03">March 2024</option>
                <option value="2024-04">April 2024</option>
                <option value="2024-05">May 2024</option>
                <option value="2024-06">June 2024</option>
                <option value="2024-07">July 2024</option>
                <option value="2024-08">August 2024</option>
                <option value="2024-09">September 2024</option>
                <option value="2024-10">October 2024</option>
                <option value="2024-11">November 2024</option>
                <option value="2024-12">December 2024</option>
            </select>
            <button onclick="calculateSalaries()" class="btn-primary">Calculate Salaries</button>
            <button onclick="processPayroll()" class="btn-primary">Process Payroll</button>
        </div>

        <!-- Salary Calculation -->
        <div class="table-section">
            <h2>Monthly Salary Details</h2>
            <table id="salaryTable">
                <thead>
                    <tr>
                        <th>Emp Code</th>
                        <th>Name</th>
                        <th>Basic</th>
                        <th>HRA</th>
                        <th>DA</th>
                        <th>PF</th>
                        <th>ESI</th>
                        <th>Prof. Tax</th>
                        <th>Gross</th>
                        <th>Deductions</th>
                        <th>Net Salary</th>
                    </tr>
                </thead>
                <tbody id="salaryList">
                    <!-- Salary details will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Payroll Summary -->
        <div class="summary-section">
            <h2>Payroll Summary</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <span>Total Employees:</span>
                    <span id="totalEmpCount">0</span>
                </div>
                <div class="summary-item">
                    <span>Total Gross Salary:</span>
                    <span id="totalGross">₹0</span>
                </div>
                <div class="summary-item">
                    <span>Total Deductions:</span>
                    <span id="totalDeductions">₹0</span>
                </div>
                <div class="summary-item">
                    <span>Total Net Salary:</span>
                    <span id="totalNet">₹0</span>
                </div>
            </div>
        </div>

        <!-- Payslip Modal -->
        <div id="payslipModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closePayslip()">&times;</span>
                <h2>Payslip</h2>
                <div id="payslipContent">
                    <!-- Payslip content will be generated here -->
                </div>
                <button onclick="printPayslip()" class="btn-primary">Print Payslip</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Check if user is logged in
        checkAuth();

        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        let salaryData = [];

        // Set current month
        const now = new Date();
        document.getElementById('salaryMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        function calculateSalaries() {
            const tbody = document.getElementById('salaryList');
            tbody.innerHTML = '';
            salaryData = [];
            
            let totalGross = 0;
            let totalDeduct = 0;
            let totalNetSalary = 0;
            
            employees.forEach(emp => {
                // Simple salary calculation (not actual Indian payroll rules)
                const basic = emp.salary;
                const hra = Math.round(basic * 0.4); // 40% of basic
                const da = Math.round(basic * 0.1); // 10% of basic
                const gross = basic + hra + da;
                
                // Deductions
                const pf = Math.round(basic * 0.12); // 12% of basic
                const esi = gross < 21000 ? Math.round(gross * 0.0075) : 0; // 0.75% if eligible
                const profTax = 200; // Fixed for simplicity
                const totalDeductions = pf + esi + profTax;
                
                const netSalary = gross - totalDeductions;
                
                const salaryRecord = {
                    empId: emp.id,
                    empCode: emp.empCode,
                    name: emp.name,
                    basic: basic,
                    hra: hra,
                    da: da,
                    pf: pf,
                    esi: esi,
                    profTax: profTax,
                    gross: gross,
                    deductions: totalDeductions,
                    netSalary: netSalary
                };
                
                salaryData.push(salaryRecord);
                
                totalGross += gross;
                totalDeduct += totalDeductions;
                totalNetSalary += netSalary;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${emp.empCode}</td>
                    <td>${emp.name}</td>
                    <td>₹${basic.toLocaleString('en-IN')}</td>
                    <td>₹${hra.toLocaleString('en-IN')}</td>
                    <td>₹${da.toLocaleString('en-IN')}</td>
                    <td>₹${pf.toLocaleString('en-IN')}</td>
                    <td>₹${esi.toLocaleString('en-IN')}</td>
                    <td>₹${profTax.toLocaleString('en-IN')}</td>
                    <td>₹${gross.toLocaleString('en-IN')}</td>
                    <td>₹${totalDeductions.toLocaleString('en-IN')}</td>
                    <td><strong>₹${netSalary.toLocaleString('en-IN')}</strong></td>
                `;
                
                row.onclick = () => showPayslip(salaryRecord);
                row.style.cursor = 'pointer';
            });
            
            // Update summary
            document.getElementById('totalEmpCount').textContent = employees.length;
            document.getElementById('totalGross').textContent = `₹${totalGross.toLocaleString('en-IN')}`;
            document.getElementById('totalDeductions').textContent = `₹${totalDeduct.toLocaleString('en-IN')}`;
            document.getElementById('totalNet').textContent = `₹${totalNetSalary.toLocaleString('en-IN')}`;
        }

        function processPayroll() {
            if (salaryData.length === 0) {
                alert('Please calculate salaries first!');
                return;
            }
            
            const month = document.getElementById('salaryMonth').value;
            const payrollRecord = {
                month: month,
                processedDate: new Date().toISOString(),
                salaries: salaryData
            };
            
            // Save to local storage
            let payrollHistory = JSON.parse(localStorage.getItem('payrollHistory') || '[]');
            payrollHistory.push(payrollRecord);
            localStorage.setItem('payrollHistory', JSON.stringify(payrollHistory));
            
            alert('Payroll processed successfully!');
        }

        function showPayslip(salary) {
            const modal = document.getElementById('payslipModal');
            const content = document.getElementById('payslipContent');
            const month = document.getElementById('salaryMonth').value;
            
            content.innerHTML = `
                <div class="payslip">
                    <h3>Indian Payroll System</h3>
                    <p><strong>Payslip for ${month}</strong></p>
                    <hr>
                    <p><strong>Employee:</strong> ${salary.name}</p>
                    <p><strong>Employee Code:</strong> ${salary.empCode}</p>
                    <hr>
                    <h4>Earnings</h4>
                    <table class="payslip-table">
                        <tr><td>Basic Salary:</td><td>₹${salary.basic.toLocaleString('en-IN')}</td></tr>
                        <tr><td>HRA:</td><td>₹${salary.hra.toLocaleString('en-IN')}</td></tr>
                        <tr><td>DA:</td><td>₹${salary.da.toLocaleString('en-IN')}</td></tr>
                        <tr><td><strong>Gross Salary:</strong></td><td><strong>₹${salary.gross.toLocaleString('en-IN')}</strong></td></tr>
                    </table>
                    <h4>Deductions</h4>
                    <table class="payslip-table">
                        <tr><td>PF:</td><td>₹${salary.pf.toLocaleString('en-IN')}</td></tr>
                        <tr><td>ESI:</td><td>₹${salary.esi.toLocaleString('en-IN')}</td></tr>
                        <tr><td>Prof. Tax:</td><td>₹${salary.profTax.toLocaleString('en-IN')}</td></tr>
                        <tr><td><strong>Total Deductions:</strong></td><td><strong>₹${salary.deductions.toLocaleString('en-IN')}</strong></td></tr>
                    </table>
                    <hr>
                    <h4>Net Salary: ₹${salary.netSalary.toLocaleString('en-IN')}</h4>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closePayslip() {
            document.getElementById('payslipModal').style.display = 'none';
        }

        function printPayslip() {
            window.print();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('payslipModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Load salaries on page load
        calculateSalaries();
    </script>
</body>
</html>